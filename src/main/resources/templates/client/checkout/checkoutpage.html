<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Xác nhận OTP</title>
</head>
<body>
    <h2>Xác nhận thanh toán bằng OTP</h2>

    <label for="email">Email:</label>
    <input type="text" id="email" readonly /><br><br>

    <label for="orderId">Order ID:</label>
    <input type="number" id="orderId" value="1" /><br><br>

    <button onclick="sendOtp()">Gửi mã OTP</button>

    <br><br>

    <input type="text" id="otpInput" placeholder="Nhập mã OTP" />
    <button onclick="verifyOtp()">Xác thực OTP</button>

    <p id="otpError" style="color: red;"></p>

    <script>
        // Lấy email của người dùng đã đăng nhập
        function fetchUserInfo() {
            fetch('/data/userInfo', {
                method: 'GET',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include'
            })
            .then(res => res.json())
            .then(data => {
                if (data.email) {
                    document.getElementById("email").value = data.email;
                } else {
                    alert("Không thể lấy email của người dùng.");
                }
            })
            .catch(() => alert("Lỗi khi lấy thông tin người dùng."));
        }

        // Gửi OTP đến email của người dùng
        function sendOtp() {
            const orderId = document.getElementById("orderId").value;

            fetch('/otp/send', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({ orderId: orderId })
            })
            .then(res => res.json())
            .then(data => alert(data.message))
            .catch(() => alert("Gửi OTP thất bại."));
        }

        // Xác thực OTP
        function verifyOtp() {
            const otp = document.getElementById("otpInput").value;
            const orderId = document.getElementById("orderId").value;

            fetch('/otp/verify', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({ otp: otp, orderId: orderId })
            })
            .then(res => res.json())
            .then(data => {
                if (data.message === 'Xác minh OTP thành công') {
                    window.location.href = "/checkout/success";
                } else {
                    document.getElementById("otpError").innerText = data.message;
                }
            })
            .catch(() => {
                document.getElementById("otpError").innerText = "Có lỗi xảy ra trong quá trình xác minh.";
            });
        }

        // Gọi hàm fetchUserInfo khi trang được tải
        window.onload = fetchUserInfo;
    </script>
</body>
</html>
